<div ng-controller="inspectionController" flex="" layout="column" class="page" id="nav">
   <section>
    <md-content class="centerPage" style="margin-bottom:85px;" id="centerPage">
    <div layout="row" layout-align="space-between center">
        <h3 class="md-subhead insTitle" >Sections &amp; Subsections</h3>
<!--
        <md-menu>
        <md-button class="md-icon-button" aria-label="section menu" ng-click="$mdOpenMenu($event)">
            <md-icon md-svg-icon="more_vert"></md-icon>
        </md-button>
         <md-menu-content>
           <md-menu-item>
             <md-button ng-click="toggleEditMode()" aria-label="Toggle Edit Mode">
               <md-icon md-menu-align-target md-svg-icon="mode_edit"></md-icon>
               {{castleService.editMode ? 'Exit' : 'Enter'}} Edit Mode
             </md-button>
           </md-menu-item>
         </md-menu-content>
        </md-menu>
-->
    </div>
              
    <md-card id="secParent" 
       layout="column"  
       ui-sortable="{'ui-floating': false, 'handle': '.handle', 'containment': '#secParent'}"  
       ng-model="report.sections">
        
        <div ng-repeat="section in report.sections track by $index" 
             layout="column" 
             layout-align="center stretch" 
             style="text-align-left;"
             ng-init="clicked = false"
              >             
               <div  style="padding:0px 0px 0px 16px; margin:0;
                         vertical-align:middle; border-radius:0; 
                         text-transform:none; background-color:#FFF;  height:52px;" 
                       class="md-no-style" 
                       aria-label="{{section.title}}"
                       layout="row" 
                       layout-align="start center"
                       ng-click="toggleAccordianIndex($index)"
                       ng-show="!castleService.editMode"
               >
                    <input type="text" 
                           ng-disabled="true" 
                           ng-model="section.title" 
                           style="background-color:inherit;"
                           class="editInput nonEditInput"
                           ng-class="castleService.editMode ? 'inputBorder' : 'nonEditInput'" />
                    <span flex=""></span>
                    <md-icon md-svg-icon="check" ng-show="isSectionComplete(section)"></md-icon>
                    <md-button
                       aria-label="toggle pages menu"
                       class="md-icon-button"
                       >
                        <md-icon md-svg-icon="{{matchesAccordianIndex($index) ? 'keyboard_arrow_up' : 'keyboard_arrow_down'}}"></md-icon>
                    </md-button>
              </div>
               <div  style="padding:0px 0px 0px 16px; margin:0;
                         vertical-align:middle; border-radius:0; 
                         text-transform:none; background-color:white; height:52px;" 
                       class="md-no-style" 
                       aria-label="{{section.title}}"
                       layout="row" 
                       layout-align="start center"
                       ng-show="castleService.editMode"
               >
                <div  class="handle" style="margin-right:6px;">
                  <md-icon md-svg-icon="./img/drag.svg" ></md-icon>
                </div>
                <input type="text" 
                       ng-disabled="false" 
                       ng-model="section.title" 
                       style="background-color:white;"
                       class="editInput nonEditInput"
                       ng-class="castleService.editMode ? 'inputBorder' : 'nonEditInput'" />
                <span flex=""></span>
                
                <md-button
                   aria-label="toggle pages menu"
                   ng-click="toggleAccordianIndex($index)"
                   class="md-icon-button"
                   >
                    <md-icon md-svg-icon="{{matchesAccordianIndex($index) ? 'keyboard_arrow_up' : 'keyboard_arrow_down'}}"></md-icon>
                </md-button>
                <md-menu style="" ng-show="castleService.editMode">
                    <md-button class="md-icon-button" aria-label="section menu" ng-click="$mdOpenMenu($event)">
                        <md-icon  md-svg-icon="more_vert"></md-icon>
                    </md-button>
                     <md-menu-content>

                          <md-menu-item>
                        <md-button ng-click="addSection(report.sections, $index)" 
                                   aria-label="Enter Edit Mode">
                           <md-icon md-svg-icon="add"></md-icon>
                           Add Section
                         </md-button>
                         </md-menu-item>
                       <md-menu-item>
                         <md-button ng-click="addSubsection(section.pages, 0);setAccordianIndex($index)" 
                                    aria-label="Enter Edit Mode">
                           <md-icon md-svg-icon="add"></md-icon>
                           Add Subsection
                         </md-button>
                         </md-menu-item>
                         <md-menu-item>
                         <md-button ng-click="remove(report.sections, $index)" aria-label="Enter Edit Mode">
                           <md-icon md-svg-icon="cancel"></md-icon>
                           Delete Section
                         </md-button>
                          </md-menu-item>
                     </md-menu-content>
                </md-menu>
              </div>
              <div ng-if="matchesAccordianIndex($index)" 
                   id="subsecParent" 
                   ui-sortable="{'ui-floating': false, 'handle': '.subhandle', 'containment': '#secParent'}"  
                   ng-model="section.pages"
                   >
                    <div ng-repeat="page in section.pages  track by $index" 
                         layout="column" 
                         layout-align="center stretch" 
                         class="sortdivider" 
                         style="height:40px;">
<!--                      <md-divider></md-divider>-->
                      <div layout="row" layout-align="start center">              
                           <span style="margin-left:28px;" ng-show="castleService.editMode">
                               <span  class="subhandle" style="text-align:right;" >
                                  <md-icon   md-svg-icon="./img/drag.svg" style="width:30px;"></md-icon>
                               </span>
                           </span>
                           <span ng-show="castleService.editMode" style="padding-left:8px;">
                               <input type="text" 
                               ng-model="page.title" 
                               class="inputBorder" />
<!--                               style="border-color:#DDD"-->
                           </span>
                               
                            <md-button ui-sref="page({'sectionIndex':$parent.$index, 'pageIndex':$index})" 
                                       class="theButton"
                                       aria-label="navigate to page"
                                       > 
                                      <span flex="" >
                                          <span ng-if="!castleService.editMode" style="padding:0px 0px 0px 28px;">{{page.title}}</span>
                                      </span>
                            </md-button>
                            <span style="padding:0 4px; min-width:40px;">{{page.answeredCount}}/{{page.items.length}}</span>
                            <md-button ng-show="castleService.editMode" class="md-icon-button"
                                       style="min-width:40px;" 
                                       ng-init="clicked = false" 
                                       aria-label="toggle pages menu"
                                       ng-click="remove(section.pages, $index)"
                                      
                            >
                                <md-icon md-svg-icon="cancel" ></md-icon>
                            </md-button>
                       </div>
                    </div>
              </div>

            <md-divider ng-if="!$last"></md-divider>
        </div>
    </md-card>
    <div layout="row" style="padding: 0 0 10px 0;" ng-hide="castleService.assignPhotoMode" class="flex-wrap">
        <md-button ng-click="checkRequired()" class="md-raised" aria-label="Preview Report">Preview Report</md-button>
        <md-button ng-click="" class="md-raised" aria-label="Save Report">Save Report</md-button>
        <md-button ng-click="castleService.reportTemplate = null" class="md-raised md-primary" aria-label="Reset Template">Reset Template</md-button>
    </div>
        
        
    </md-content>
    </section>
</div>

<!--<div class="inspectionDialog">This could be a problem</div>-->